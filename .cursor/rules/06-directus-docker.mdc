---
description: Configuración y reglas para Directus con Docker
---

# Directus con Docker - Panel de Administración

## Propósito

Directus sirve como **panel de administración headless CMS** para gestionar el contenido de la base de datos compartida con el proyecto Next.js.

## Configuración

### Arquitectura
```
cdh-admin/
├── docker-compose.yml    # Orquestación de servicios
├── .env                  # Variables de entorno
└── directus-data/        # Volumen persistente (auto-generado)
```

### Conexión a Base de Datos

**IMPORTANTE**: Directus se conecta a la **misma base de datos PostgreSQL de Supabase** que usa el proyecto Next.js `cdh`.

- **NO** usa una base de datos local separada para los datos principales
- **SÍ** comparte todas las tablas: User, Course, Module, Lesson, etc.
- Cualquier cambio en Directus se refleja inmediatamente en la aplicación Next.js

### Variables de Entorno Clave

```env
# Base de Datos COMPARTIDA (Supabase)
DB_CLIENT=postgres
DB_HOST=db.xxx.supabase.co
DB_PORT=5432
DB_DATABASE=postgres
DB_USER=postgres
DB_PASSWORD=tu-password-supabase

# Configuración de Directus
KEY=clave-secreta-aleatoria-minimo-32-caracteres
SECRET=otra-clave-secreta-diferente-minimo-32

# Administrador Inicial
ADMIN_EMAIL=admin@cdh.local
ADMIN_PASSWORD=password-seguro

# Acceso
PUBLIC_URL=http://localhost:8055
```

## Comandos Docker

### Iniciar Directus
```bash
cd cdh-admin
docker-compose up -d
```

### Ver Logs
```bash
docker-compose logs -f
```

### Detener Servicios
```bash
docker-compose down
```

### Detener y Eliminar Datos
```bash
docker-compose down -v  # ⚠️ Elimina volúmenes
```

### Reiniciar Servicios
```bash
docker-compose restart
```

## Acceso a Directus

- **URL**: http://localhost:8055
- **Usuario**: El definido en `ADMIN_EMAIL`
- **Contraseña**: La definida en `ADMIN_PASSWORD`

## Gestión de Contenido

### Colecciones Disponibles (desde Supabase)

Al iniciar, Directus detecta automáticamente estas tablas:

1. **User** - Usuarios del sistema
2. **Course** - Cursos disponibles
3. **Module** - Módulos de cursos
4. **Lesson** - Lecciones con videos
5. **Purchase** - Compras realizadas
6. **Commission** - Comisiones de afiliados
7. **LessonProgress** - Progreso de usuarios
8. **Account** / **Session** - Tablas de NextAuth

### Operaciones Permitidas

**CRUD Completo**: Directus permite crear, leer, actualizar y eliminar registros de todas las tablas.

**⚠️ PRECAUCIÓN**:
- Cambios en Directus afectan la aplicación Next.js en tiempo real
- No modifiques tablas de NextAuth (Account, Session) a menos que sepas lo que haces
- No elimines registros con relaciones sin verificar dependencias

### Casos de Uso Típicos

1. **Crear Cursos**: Añadir nuevos cursos con nombre y precio
2. **Gestionar Módulos**: Organizar módulos dentro de cursos
3. **Añadir Lecciones**: Subir lecciones con IDs de video de Vimeo
4. **Ver Usuarios**: Consultar usuarios registrados y su progreso
5. **Monitorear Compras**: Ver historial de compras y comisiones

## Buenas Prácticas

### Seguridad
- Cambia `ADMIN_PASSWORD` a algo seguro en producción
- Genera `KEY` y `SECRET` con: `openssl rand -base64 32`
- No expongas el puerto 8055 públicamente sin autenticación adicional

### Respaldo
- La base de datos está en Supabase (respaldada automáticamente)
- Considera exportar configuraciones de Directus periódicamente

### Desarrollo
- Usa Directus para gestión rápida de contenido
- Para cambios de esquema, usa Prisma migrations (no Directus)
- Directus es para **datos**, Prisma es para **estructura**

## Solución de Problemas

### Error: "Can't connect to database"
- Verifica que las credenciales de Supabase sean correctas
- Verifica que Supabase no esté pausado
- Revisa la URL de conexión en `.env`

### Error: "Port 8055 already in use"
- Cambia el puerto en `docker-compose.yml`: `"8056:8055"`
- O detén el proceso que usa el puerto 8055

### Directus no muestra las tablas
- Verifica que `DB_CLIENT=postgres` esté configurado
- Verifica que la conexión a Supabase funcione
- Revisa logs: `docker-compose logs directus`

### Quiero resetear la configuración de Directus
```bash
docker-compose down -v
docker-compose up -d
```
Esto eliminará configuraciones de Directus pero NO los datos de Supabase.
